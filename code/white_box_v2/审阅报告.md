代码审阅报告：white_box_v2/codex

  一、整体架构与 CONTEXT.md 的对应关系

  代码由 5 个模块组成，实现了 CONTEXT.md Section B 描述的三项损失白盒攻击框架：

  模块: config.py
  职责: 全局超参数
  与方法论对应: 损失权重、扰动约束、prompt 定义
  ────────────────────────────────────────
  模块: attack_core.py
  职责: PGD 优化 + 三项损失
  与方法论对应: $\mathcal{L} = \lambda_{\text{emo}} \mathcal{L}{\text{emo}} + \lambda{\text{asr}} \mathcal{L}{\text{asr}} + \lambda{\text{per}}
    \mathcal{L}_{\text{per}}$
  ────────────────────────────────────────
  模块: opens2s_io.py
  职责: 模型加载 + 可微特征提取
  与方法论对应: 梯度链：波形→STFT→Mel→模型
  ────────────────────────────────────────
  模块: run_attack.py
  职责: 主流程：加载→攻击→评估→保存
  与方法论对应: 输入/输出完整流水线
  ────────────────────────────────────────
  模块: eval_metrics.py
  职责: WER / SNR / L∞ / L2
  与方法论对应: 评估指标

  三项损失的代码实现与 CONTEXT.md 的公式 形式上一致。但有几个值得深挖的问题。

---

  二、审阅发现：站得住脚的部分

1. 梯度链设计正确

  opens2s_io.py:43-135 的 TorchWhisperFeatureExtractor 用纯 PyTorch 重写了 Whisper 的特征提取（STFT → mel 滤波器组 → log
  归一化），使梯度可以从模型输出一路反传到原始波形。这是白盒攻击的核心前提，实现正确。

  attack_core.py:270-278 还做了梯度链完整性检查（连续 3 步梯度范数 < 1e-8 就报错），是好的工程实践。

2. 情绪成功判据是严格的

  run_attack.py:246: success_emo = all(p == cfg.target_emotion for p in emo_pred_adv) — 要求 全部 3 个不同 prompt
  都输出目标情绪才算成功。这是一个严格标准，不存在放水。

3. L∞ 投影正确

  attack_core.py:283: delta.data.clamp_(-cfg.epsilon, cfg.epsilon) + 第 225 行 torch.clamp(waveform + delta, -1.0, 1.0) — 标准 PGD 投影，确保扰动同时满足
  L∞ 约束和波形合法范围。

---

  三、审阅发现：需要关注的问题

  问题 1（严重）：语义一致性约束几乎失效

  CONTEXT.md 说攻击目标是 "同时保持语义内容基本不变"，但实验数据暴露了一个严重矛盾：

  从 testN10/results/summary.json 看：
  {
    "emo_success_rate": 0.8,
    "wer_le_0.0": 0.0,      // 0% 的样本 WER=0
    "joint_success_le_0.0": 0.0,
    "wer_le_0.05": 0.0,     // 0% 的样本 WER≤5%
    "joint_success_le_0.05": 0.0
  }

  10 个样本中没有一个保住了语义。例如样本 00000：

- 攻击前转录："打眼一看，它们确实很美。"
- 攻击后转录："他们确实很漂亮"
- WER = 1.0（100%）

  根因在 config.py 的权重设计：

  ┌───────────────────────┬───────┬───────┬───────┬──────────────┐
  │         阶段          │ λ_emo │ λ_asr │ λ_per │ ASR 相对权重 │
  ├───────────────────────┼───────┼───────┼───────┼──────────────┤
  │ Stage A（step 0-19）  │ 1.0   │ 1e-4  │ 0.0   │ 0.01%        │
  ├───────────────────────┼───────┼───────┼───────┼──────────────┤
  │ Stage B（step 20-59） │ 1.0   │ 1e-2  │ 1e-5  │ 1%           │
  └───────────────────────┴───────┴───────┴───────┴──────────────┘

  ASR 损失权重比情绪损失低 2-4 个数量级。优化器几乎完全忽略语义约束——$\mathcal{L}_{\text{asr}}$ 在总损失中的贡献微乎其微。

  这在论文中很难自圆其说：如果声称是三项联合优化，但实际上两项约束加在一起贡献不到总损失的 2%，reviewer 会质疑语义一致性约束是否只是摆设。

  问题 2（中等）：感知损失形同虚设

  config.py:51-52:
  lambda_per_stage_a: float = 0.0    # Stage A 完全关闭
  lambda_per_stage_b: float = 1e-5   # Stage B 权重是情绪损失的 0.001%

  从 loss_trace 数据看，step 20 后 per 值约 0.05-0.08，乘以 1e-5 后对总损失的贡献约
  5e-7，完全可以忽略。感知损失在当前配置下不起任何实际作用，扰动的人耳不可感知性完全依赖 L∞ ε=0.008 的硬约束。

  如果论文要报告 "多分辨率 STFT 感知损失" 作为方法贡献，这个设置是站不住脚的。

  问题 3（中等）：EoT 仅 N=1，名不副实

  config.py:55: eot_samples: int = 1

  EoT（Expectation over Transformation）的核心思想是对多个随机变换取期望以提升鲁棒性。N=1 意味着每步只采样一组随机参数，没有对变换求期望——这本质上退化为
  随机数据增强，不是真正的 EoT。

  CONTEXT.md 提到 "跨 prompt 鲁棒性差（CoT 类 ~20%）"，这一问题可能部分源于此：攻击优化时没有真正在变换空间上做均值化。

  问题 4（轻微）：训练/评估特征提取器不一致

- 攻击优化时用 TorchWhisperFeatureExtractor（自定义 PyTorch 实现）
- 评估推理时用官方 WhisperFeatureExtractor（HuggingFace numpy 实现）

  opens2s_io.py:269-276 vs opens2s_io.py:274-276

  两者的 STFT 实现可能存在微小数值差异（浮点精度、窗函数边界处理等）。这意味着攻击优化的特征空间与最终评估的特征空间不完全相同。这是白盒攻击研究中的常见做
  法，但值得在论文的 limitations 中提及。

  问题 5（轻微）：第三个 prompt 在干净音频上就不稳定

  从样本 00000 看：
  "emo_text_clean": ["Angry", "Angry", "哦，它们确实很美，不过你听起来"]
  "emo_pred_clean": ["angry", "angry", ""]

  第三个 prompt "Emotion label only (one word): happy, sad, angry, or neutral."
  在干净音频上就没有正确输出情绪标签（输出了无关中文），归一化后为空字符串。但攻击后该 prompt 却正确输出了 "happy"。

  这说明模型对不同 prompt 格式的遵从度不一致，攻击可能通过扰动"修复"了模型的指令遵从能力，而不是单纯改变了情绪判断。这一点如果出现在论文数据中，reviewer
  可能会追问。

---

  四、总结评价

  ┌────────────────────┬──────────────────────────────────────────────────────────┐
  │        维度        │                           评价                           │
  ├────────────────────┼──────────────────────────────────────────────────────────┤
  │ 代码正确性         │ PGD、梯度链、L∞ 投影、损失计算均正确                     │
  ├────────────────────┼──────────────────────────────────────────────────────────┤
  │ 与 CONTEXT.md 对应 │ 三项损失形式匹配，但权重配置使 ASR 和感知损失几乎失效    │
  ├────────────────────┼──────────────────────────────────────────────────────────┤
  │ 可复现性           │ 配置集中、随机种子固定、结果 JSON 包含完整 trace，可复现 │
  ├────────────────────┼──────────────────────────────────────────────────────────┤
  │ 最大风险点         │ WER=100% 与 "保持语义不变" 的声明直接矛盾                │
  └────────────────────┴──────────────────────────────────────────────────────────┘

  核心建议：在用此数据写论文前，需要重新调参使 joint_success（情绪翻转 + WER 可控）不为零，否则三项损失框架中的 ASR 约束和感知约束在 reviewer
  看来是无效的。

---

  五、结果 JSON 各参数含义

  以 00000_0001_000351.json 为例：

  ┌─────────────────┬────────────────────────────┬──────────────────────────────────────────┬──────────────────────────────────────────────────────┐
  │      字段       │            含义            │                  示例值                  │                         说明                         │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ sample_id       │ 样本唯一标识               │ "00000_0001_000351"                      │ 格式：{序号}_{说话人}_{文件编号}                     │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ path            │ 原始音频路径               │ "/data1/.../0001_000351.wav"             │ ESD 数据集中的源文件                                 │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ emo_text_clean  │ 干净音频的情绪识别原始输出 │ ["Angry", "Angry", "哦..."]              │ 3 个 prompt 各自的模型原始文本输出                   │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ emo_text_adv    │ 对抗音频的情绪识别原始输出 │ ["happy", "happy", "happy"]              │ 攻击后的输出                                         │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ emo_pred_clean  │ 干净音频的归一化情绪标签   │ ["angry", "angry", ""]                   │ 从原始输出中提取的标准标签，空串表示未能提取         │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ emo_pred_adv    │ 对抗音频的归一化情绪标签   │ ["happy", "happy", "happy"]              │ 攻击后提取的标签                                     │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ asr_text_clean  │ 干净音频的转录文本         │ "打眼一看，它们确实很美。"               │ 模型对原始音频的 ASR 输出                            │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ asr_text_adv    │ 对抗音频的转录文本         │ "他们确实很漂亮"                         │ 攻击后的 ASR 输出                                    │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ success_emo     │ 情绪攻击是否成功           │ true                                     │ 当且仅当 3 个 prompt 的 pred 全部等于 target_emotion │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ wer             │ 词错误率                   │ 1.0                                      │ clean 与 adv 转录之间的 WER，0=完全一致，1=完全不同  │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ delta_linf      │ 扰动 L∞ 范数               │ 0.008                                    │ max|δ|，即扰动的最大绝对值，应 ≤ ε                   │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ delta_l2        │ 扰动 L2 范数               │ 1.484                                    │ 扰动向量的欧氏长度，依赖于音频长度                   │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ snr_db          │ 信噪比（dB）               │ 17.05                                    │ $20\log_{10}(|x|_2 / |\delta|_2)$，越高表示扰动越小  │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ grad_norm_trace │ 梯度范数轨迹               │ [729.8, 284.5, ...]                      │ 每步 delta 的梯度 L2 范数，用于检查梯度链健康度      │
  ├─────────────────┼────────────────────────────┼──────────────────────────────────────────┼──────────────────────────────────────────────────────┤
  │ loss_trace      │ 损失轨迹                   │ [{step, total, emo, asr, per, ...}, ...] │ 每步的各项损失值和权重                               │
  └─────────────────┴────────────────────────────┴──────────────────────────────────────────┴──────────────────────────────────────────────────────┘

  loss_trace 中每个元素的子字段：

  ┌────────────┬────────────────────────────────────────────────────────────┐
  │   子字段   │                            含义                            │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ step       │ 优化步数（0-59）                                           │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ total      │ 加权总损失 $\lambda_e L_e + \lambda_a L_a + \lambda_p L_p$ │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ emo        │ 情绪 CE 损失（3 个 prompt 的平均）                         │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ asr        │ ASR 自一致性 CE 损失                                       │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ per        │ 多分辨率 STFT 感知损失                                     │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ lambda_emo │ 当前步的情绪损失权重                                       │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ lambda_asr │ 当前步的 ASR 损失权重（step 20 切换）                      │
  ├────────────┼────────────────────────────────────────────────────────────┤
  │ lambda_per │ 当前步的感知损失权重（step 20 切换）                       │
  └────────────┴────────────────────────────────────────────────────────────┘

  summary.json 各字段：

  ┌───────────────────────┬──────────────────────────────────────────────────────┐
  │         字段          │                         含义                         │
  ├───────────────────────┼──────────────────────────────────────────────────────┤
  │ num_samples           │ 样本总数                                             │
  ├───────────────────────┼──────────────────────────────────────────────────────┤
  │ emo_success_rate      │ 情绪攻击成功率（所有 prompt 一致命中目标情绪的比例） │
  ├───────────────────────┼──────────────────────────────────────────────────────┤
  │ wer_le_0.0            │ WER=0（转录完全不变）的样本比例                      │
  ├───────────────────────┼──────────────────────────────────────────────────────┤
  │ wer_le_0.05           │ WER≤5% 的样本比例                                    │
  ├───────────────────────┼──────────────────────────────────────────────────────┤
  │ joint_success_le_0.0  │ 同时满足情绪成功 + WER=0 的比例                      │
  ├───────────────────────┼──────────────────────────────────────────────────────┤
  │ joint_success_le_0.05 │ 同时满足情绪成功 + WER≤5% 的比例                     │
  └───────────────────────┴──────────────────────────────────────────────────────┘
